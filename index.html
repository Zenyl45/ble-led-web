<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BLE LED Controller - Setup</title>
<style>
:root {
  --bg: #0b0f15;
  --panel: #121821;
  --panel2: #0f1420;
  --muted: #8a97a6;
  --text: #e8eef5;
  --acc: #3a84ff;
  --radius: 14px;
  --gap: 14px;
}
* { box-sizing: border-box; font-family: Inter, sans-serif; }
html, body { margin: 0; height: 100%; background: var(--bg); color: var(--text); }
.hidden { display: none !important; }

.center {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100vh; text-align: center;
}
.card {
  background: var(--panel); padding: 30px 40px; border-radius: var(--radius);
  box-shadow: 0 8px 25px rgba(0,0,0,.5);
  width: min(90%, 400px);
}
input[type="number"], button {
  width: 100%; padding: 12px; margin-top: 10px; border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,.1); background: var(--panel2); color: var(--text);
  font-size: 1rem;
}
button {
  background: var(--acc); border: none; cursor: pointer; font-weight: 600;
}
button:hover { opacity: .9; }

/* Interface principale */
#main {
  display: flex; flex-direction: column; align-items: center;
  max-width: 800px; margin: 0 auto; padding: 20px;
}
header {
  display: flex; justify-content: space-between; align-items: center;
  width: 100%; margin-bottom: 20px;
}
h1 { margin: 0; }
#settingsBtn {
  background: none; border: 1px solid var(--muted); padding: 8px 12px;
  border-radius: 10px; color: var(--muted); cursor: pointer;
  position: fixed; top: 16px; left: 16px;
}
#settingsBtn:hover { border-color: var(--text); color: var(--text); }

/* Param√®tres modale */
#settingsModal {
  position: fixed; inset: 0; background: rgba(0,0,0,.65);
  display: flex; align-items: center; justify-content: center;
}
.modal-box {
  background: var(--panel2); padding: 24px; border-radius: var(--radius);
  width: min(90%, 360px); box-shadow: 0 10px 30px rgba(0,0,0,.5);
}
.modal-box h2 { margin-top: 0; }
.modal-box input { margin-top: 8px; width: 100%; }
.modal-box .actions {
  display: flex; gap: 10px; margin-top: 16px;
}
.modal-box button { flex: 1; }
.status {
  color: var(--muted);
  margin-top: 8px;
  font-size: 0.9rem;
}
</style>
</head>
<body>

<!-- üß© Setup √©cran -->
<div id="setup" class="center">
  <div class="card">
    <h1>‚öôÔ∏è Configuration</h1>
    <p>Bienvenue ! Indique le nombre de LEDs sur ton ruban :</p>
    <input type="number" id="ledCount" min="1" max="1000" placeholder="ex: 60" />
    <button id="saveSetup">Continuer</button>
  </div>
</div>

<!-- üåà Interface principale -->
<div id="main" class="hidden">
  <header>
    <h1>BLE LED Controller</h1>
  </header>

  <button id="settingsBtn">‚öôÔ∏è</button>
  <p>üéá Nombre de LEDs configur√© : <strong id="ledDisplay"></strong></p>
  <button id="connectBtn">Se connecter √† l'ESP32</button>
  <p class="status" id="status">D√©connect√©</p>
</div>

<!-- ‚öôÔ∏è Modale Param√®tres -->
<div id="settingsModal" class="hidden">
  <div class="modal-box">
    <h2>Param√®tres</h2>
    <label for="ledCountEdit">Nombre de LEDs</label>
    <input type="number" id="ledCountEdit" min="1" max="1000" />
    <div class="actions">
      <button id="saveSettings">üíæ Enregistrer</button>
      <button id="closeSettings">‚ùå Fermer</button>
    </div>
  </div>
</div>

<script>
// ======= Variables BLE =======
const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const RX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
let device, server, service, rxChar;

// ======= Utilitaires =======
const $ = id => document.getElementById(id);
const setStatus = t => $('status').textContent = t;

// ======= Initialisation =======
window.addEventListener('DOMContentLoaded', () => {
  const leds = localStorage.getItem('ledCount');
  if (leds) {
    $('ledDisplay').textContent = leds;
    $('setup').classList.add('hidden');
    $('main').classList.remove('hidden');
  }
});

// ======= √âcran de setup =======
$('saveSetup').addEventListener('click', () => {
  const count = parseInt($('ledCount').value);
  if (!count || count <= 0) return alert('Entre un nombre valide !');
  localStorage.setItem('ledCount', count);
  $('ledDisplay').textContent = count;
  $('setup').classList.add('hidden');
  $('main').classList.remove('hidden');
});

// ======= Param√®tres =======
$('settingsBtn').addEventListener('click', () => {
  const current = localStorage.getItem('ledCount') || '';
  $('ledCountEdit').value = current;
  $('settingsModal').classList.remove('hidden');
});

$('closeSettings').addEventListener('click', () => {
  $('settingsModal').classList.add('hidden');
});

$('saveSettings').addEventListener('click', () => {
  const newVal = parseInt($('ledCountEdit').value);
  if (!newVal || newVal <= 0) return alert('Nombre invalide');
  localStorage.setItem('ledCount', newVal);
  $('ledDisplay').textContent = newVal;
  $('settingsModal').classList.add('hidden');
  alert('‚úÖ Param√®tres enregistr√©s !');
});

// ======= Connexion BLE =======
async function connectBLE() {
  try {
    setStatus('üîç Recherche du p√©riph√©rique...');
    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }]
    });
    setStatus('üîó Connexion en cours...');
    server = await device.gatt.connect();
    service = await server.getPrimaryService(SERVICE_UUID);
    rxChar = await service.getCharacteristic(RX_UUID);

    setStatus('‚úÖ Connect√© √† ' + (device.name || 'ESP32'));

    // Envoyer le nombre de LEDs
    const leds = parseInt(localStorage.getItem('ledCount') || 0);
    if (rxChar && leds > 0) {
      const data = new Uint8Array([0x06, leds & 0xFF, (leds >> 8) & 0xFF]);
      await rxChar.writeValueWithoutResponse(data);
      console.log('Envoi config LEDs:', data);
    }

    device.addEventListener('gattserverdisconnected', () => {
      setStatus('‚ùå D√©connect√©');
    });
  } catch (e) {
    console.error(e);
    setStatus('‚ö†Ô∏è Erreur connexion BLE');
  }
}

$('connectBtn').addEventListener('click', connectBLE);
</script>
</body>
</html>
